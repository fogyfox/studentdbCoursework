<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админ панель</title>
    <style>
        .tab { display: none; }
        .tab.active { display: block; }
        button.tab-button { margin-right: 5px; }
    </style>
</head>
<body>

<h2>Админ панель</h2>

<!-- Кнопки вкладок -->
<div>
    <button class="tab-button" data-tab="users">Пользователи</button>
    <button class="tab-button" data-tab="courses">Предметы</button>
</div>

<!-- ========================= -->
<!-- Вкладка: Пользователи -->
<!-- ========================= -->
<div id="users" class="tab active">
    <h3>Пользователи</h3>

    <table border="1">
        <thead>
        <tr>
            <th>ID</th>
            <th>Логин</th>
            <th>Роль</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="usersTable"></tbody>
    </table>

    <h3>Добавить пользователя</h3>
    <input id="newUserLogin" placeholder="Логин">
    <input id="newUserPassword" type="password" placeholder="Пароль">
    <select id="newUserRole">
        <option value="STUDENT">STUDENT</option>
        <option value="TEACHER">TEACHER</option>
        <option value="ADMIN">ADMIN</option>
    </select>
    <button id="addUserBtn">Создать</button>
</div>

<!-- ========================= -->
<!-- Вкладка: Предметы -->
<!-- ========================= -->
<div id="courses" class="tab">
    <h3>Предметы</h3>

    <table border="1">
        <thead>
        <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody id="coursesTable"></tbody>
    </table>

    <h3>Добавить предмет</h3>
    <input id="newSubjectName" placeholder="Название предмета">
    <button id="addCourseBtn">Создать</button>
</div>

<script src="main.js"></script>
<script>
const role = sessionStorage.getItem("role");
if (role !== "ADMIN") {
    alert("Доступ запрещён");
    location.href = "index.html";
}

/* =========================
   Переключение вкладок
========================= */
document.querySelectorAll(".tab-button").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.getElementById(btn.dataset.tab).classList.add("active");

        if (btn.dataset.tab === "users") loadUsers();
        if (btn.dataset.tab === "courses") loadCourses();
    });
});

/* =========================
   Пользователи
========================= */
async function loadUsers() {
    const users = await apiFetch("/admin/users", { method: "GET" });
    const table = document.getElementById("usersTable");
    table.innerHTML = "";

    users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${u.id}</td>
            <td>${u.login}</td>
            <td>${u.role}</td>
            <td>
                <button onclick="deleteUser(${u.id})">Удалить</button>
                <button onclick="resetPassword(${u.id}, '${u.login}', '${u.role}')">Сбросить пароль</button>
            </td>
        `;
        table.appendChild(tr);
    });
}

// Функция сброса пароля
function resetPassword(id, login, role) {
    const newPassword = prompt("Введите новый пароль для пользователя:");
    if (!newPassword) return;

    apiFetch(`/admin/users/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", role: sessionStorage.getItem("role") },
        body: JSON.stringify({ login, role, password: newPassword })
    }).then(res => {
        if (res.status === "success") alert("Пароль успешно сброшен");
        else alert(res.error || "Ошибка при сбросе пароля");
    });
}

document.getElementById("addUserBtn").onclick = async () => {
    const login = newUserLogin.value;
    const password = newUserPassword.value;
    const role = newUserRole.value;

    const res = await apiFetch("/admin/users", {
        method: "POST",
        body: JSON.stringify({ login, password, role })
    });

    if (res.error) alert(res.error);
    else loadUsers();
};

window.deleteUser = async (id) => {
    const res = await apiFetch(`/admin/users/${id}`, { method: "DELETE" });
    if (res.error) alert(res.error);
    else loadUsers();
};

/* =========================
   Предметы
========================= */
async function loadCourses() {
    const courses = await apiFetch("/admin/courses", { method: "GET" });
    const table = document.getElementById("coursesTable");
    table.innerHTML = "";

    courses.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td>
                <button onclick="deleteSubject(${s.id})">Удалить</button>
            </td>
        `;
        table.appendChild(tr);
    });
}

document.getElementById("addCourseBtn").onclick = async () => {
    const name = newSubjectName.value;

    const res = await apiFetch("/admin/courses", {
        method: "POST",
        body: JSON.stringify({ name })
    });

    if (res.error) alert(res.error);
    else loadCourses();
};

window.deleteSubject = async (id) => {
    const res = await apiFetch(`/admin/courses/${id}`, { method: "DELETE" });
    if (res.error) alert(res.error);
    else loadCourses();
};

/* =========================
   Начальная загрузка
========================= */
loadUsers();
</script>

</body>
</html>
